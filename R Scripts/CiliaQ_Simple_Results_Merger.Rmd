---
title: "CiliaQ - Simple results merger"
author: "This R Markdown template was generated by Jan N. Hansen for [CiliaQ](https://github.com/hansenjn/CiliaQ) data"
date: "" %TODO enter the date
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load librarys
```{r load}
library(data.table)
library(readxl)
library(readr)
library("ggplot2")
library(tidyr)
library("openxlsx")
library(matrixStats)
```

## Define file path
**TODO:** Enter the file path to the folder where your CiliaQ files are stored inbetween the "" as datapath. They need to be all in one folder to perform this analysis:
```{r}
datapath = "" 
```

**TODO:** Enter the file path to the folder where you want to store the tables that are produced by this R script inbetween the "" as outputpath:
```{r}
outputpath = ""
```

## Define file names
**TODO:** Indicate as expID how all file names begin (in case they start with the same name). If they do not have a common beginning, enter nothing here.
```{r}
expID = ""
```

**TODO:** As conditions enter the filename parts that are individual to each file. For example, see below a combination of genotype (KO vs WT) and time (t000, t015, t030)). Note, that you should not enter here any filetype suffixes (e.g. .tif, .lif, ...) or suffixes that are generated during the CiliaQ pipeline (E.g. the suffix "_s1_CQP_CQS.txt").
```{r}
Conditions = sort(c("WT t000",
"KO t000",
"WT t015",
"KO t015",
"WT t030",
"KO t030"))
```

This part of code creates the list of CiliaQ file names that exist and will be loaded in the next step.
```{r}
files = c(paste0(expID," ",Conditions,"_s1_CQP_CQs.txt"),paste0(expID," ",Conditions,"_s2_CQP_CQs.txt"))
files = sort(files)

files = ifelse(file.exists(paste0(datapath,files)),files, sort(c(paste0(expID," ",Conditions,"_s1_CQP_ed_CQs.txt"),paste0(expID," ",Conditions,"_s2_CQP_ed_CQs.txt"))))

```

The following files will be loaded:
```{r}
files
```

Do they exist?
```{r}
all(file.exists(paste0(datapath,files)))
```

## Define column names in files
Here we define a vector that indicates in which columns in the CiliaQ output file which preferences are stored. Note that the parameter names are in some cases shortened to fit into the labeling of tabs in an Excel file.
```{r}
cols <- c("Name",
          "Note",
          "ID",
          "x center [micron]",
          "y center [micron]",
          "z center [micron]",
          "Volume [voxel]",
          "Volume [micron^3]",
          "N surface voxels",
          "Surface [micron^2]",
          "Shape complexity index",
          "Sphere radius [micron]",
          "Maximum span [micron]",
          "A Coloc volume [micron^3]",
          "A Coloc volume [% tot vol]",
          "B Coloc volume [micron^3]",
          "B Coloc volume [% tot vol]",
          "A Coloc comp BG [micron^3]",
          "A Coloc comp BG [% tot vol]",
          "B Coloc comp BG [micron^3]",
          "B Coloc comp BG [% tot vol]",
          "minimum intensity (rec.C)",
          "maximum intensity (rec.C)",
          "average intensity 10% (rec.C)",
          "average intensity (rec.C)",
          "SD of intensity (rec.C)",
          "minimum A intensity",
          "maximum A intensity",
          "average A intensity of hi 10%",
          "average A intensity",
          "SD of A intensity",
          "minimum B intensity",
          "maximum B intensity",
          "average B intensity of hi 10%",
          "average B intensity",
          "SD of B intensity",
          "N of found skeletons",
          "N branches",
          "tree length [micron]",
          "cilia length [micron]",
          "orientation vector x [micron]",
          "orientation vector y [micron]",
          "orientation vector z [micron]",
          "cilia bending index",
          "Intensity threshold A",
          "Intensity threshold B",
          "Intensity threshold Basal Stain",
          "Integrated A intensity",
          "Average A intensity on center",
          "Integrated B intensity",
          "Average B intensity on center",
          "A Coloc center vs BG [micron]",
          "A Coloc center vs BG [% tot l]",
          "B Coloc center vs BG [micron]",
          "B Coloc center vs BG [% tot l]")
length(cols)
cols[nchar(cols)>31]
nchar(cols)[nchar(cols)>31]
```

## Load and merge data
In this chunk, all data files are opened and read and an excel file is saved, in which a tab is produced for each file containing a table for all cilia referring to that file.
```{r}
# create Workbook
ExcelOutput<-createWorkbook()

AllData <- data.frame(read_delim(paste0(datapath, files[1]), "\t", 
                                 escape_double = FALSE, col_names = FALSE, trim_ws = TRUE))[,1:55]
colnames(AllData) <- cols

AllData[,"File ID"] <- files[1]
AllData <- AllData[,c(length(AllData),1:(length(AllData)-1))]
head(AllData)

sheet <- addWorksheet(ExcelOutput, sheetName = gsub("_CQP_ed_CQs.txt","",gsub("_CQP_CQs.txt","",gsub(paste0(expID," "),"",files[1]))))
writeDataTable(ExcelOutput, sheet, AllData, withFilter=FALSE, colNames = TRUE, rowNames = TRUE)


for(id in files[2:length(files)]){
  AllDataAdd <- data.frame(read_delim(paste0(datapath, id), "\t", 
                                 escape_double = FALSE, col_names = FALSE, trim_ws = TRUE))[,1:55]
  colnames(AllDataAdd) <- cols

  AllDataAdd[,"File ID"] <- id
  AllDataAdd <- AllDataAdd[,c(length(AllDataAdd),1:(length(AllDataAdd)-1))]
  head(AllDataAdd)

  AllData <- rbind(AllData, AllDataAdd)

  sheet <- addWorksheet(ExcelOutput, sheetName = gsub("_CQP_ed_CQs.txt","",gsub("_CQP_CQs.txt","",gsub(paste0(expID," "),"",id))))
  writeDataTable(ExcelOutput, sheet, AllDataAdd, withFilter=FALSE, colNames = TRUE, rowNames = TRUE)
}

colnames(AllData)[40]

saveWorkbook(ExcelOutput, file=file.path(outputpath, paste0(expID,"_CiliaQ_Results.xlsx")), overwrite = TRUE)
```

This chunk corrects the cilia length by adding a defined value (in this case 0.2 is added) - you may change this to 0 if you do not which to change the cilia length. However, note, that cilia that have a spherical shape will not deliver a skeleton in CiliaQ and thus will ahve a length of NA or zero. By adding a small value you may avoid that cilia in your data set have 0 length or are excluded (if left at a length of NA).
```{r}
## Length correction
AllData$`cilia length [micron]` <- AllData$`cilia length [micron]` + 0.2
AllData$`cilia length [micron]`[is.na(AllData$`cilia length [micron]`)] <- 0.2

```

In this chunk, tables for each parameter are generated and output, where each column represents a different "condition". Also an Excel file is generated that contains all of these tables as different tabs.
```{r}
max = 0;
for(id in Conditions[1:length(Conditions)]){
  if(length(AllData[AllData$`File ID`%like%id,1])>max){
    max = length(AllData[AllData$`File ID`%like%id,1])
  }
}
max

ExcelOutput<-createWorkbook()

for(colID in 4:length(cols)){
  temp <- 1:max
  temp <- data.frame(cbind(temp,AllData[AllData$`File ID` %like% Conditions[1],colID+1]))
  
  for(id in Conditions[2:length(Conditions)]){
    temp[,id] <- rep(AllData[AllData$`File ID`%like%id,colID+1],length.out=length(temp[,1]))
  }
  
  temp <- temp [,-1]
  colnames(temp) <- Conditions
  
  for(id in Conditions[1:length(Conditions)]){
    if(length(AllData[AllData$`File ID`%like%id,1]) < length(temp[,which(Conditions %like% id)])){
      temp [c(length(AllData[AllData$`File ID`%like%id,1])+1):length(temp[,which(Conditions %like% id)]),which(Conditions %like% id)] <- NA
    }
  }
  
  write.xlsx(temp, file=file.path(outputpath,paste0(expID,"_CiliaQ_Results_",cols[colID],".xlsx")))
  sheet <- addWorksheet(ExcelOutput, sheetName = cols[colID])
  writeDataTable(ExcelOutput, sheet, temp, withFilter=FALSE, colNames = TRUE, rowNames = TRUE)
}

saveWorkbook(ExcelOutput, file=file.path(outputpath, paste0(expID,"_CiliaQ_Results_By_Param.xlsx")), overwrite = TRUE)
```